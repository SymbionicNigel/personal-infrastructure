version: '3.7'
services:
  # template:
  #   container_name: template # This becomes the subdomain used by traefik
  #   image: test:${SERVICE_VERSION:-v0.0} # Allow for supplying an override in the env but supply a default
  #   restart: unless-stopped
  #   labels:
  #     traefik.enable: true
  hendrix:
    container_name: hendrix
    image: traefik:${TRAEFIK_VERSION:-v3.1}
    restart: unless-stopped
    ports:
      # The HTTP port
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # So that Traefik can listen to the Docker events
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
    labels:
      traefik.enable: True
      # traefik.http.routers.hendrix: true
      # traefik.http.routers.hendrix.entrypoints: http # TODO: Do we need this? What does it do?
      # traefik.http.services.hendrix.loadbalancer.server.port: 8080

    environment:
      HOSTNAME_TLD: "${HOSTNAME_TLD:?err}"
  whoami:
    container_name: whoami
    image: traefik/whoami
    labels:
      traefik.enable: True
      # traefik.http.routers.testcont.rule: Host(`whoami.${HOSTNAME_TLD:?err}`)
  # khazad-dum: # https://hub.docker.com/_/vault
  #   image: vault:${VAULT_VERSION:-latest}
  #   restart: unless-stopped
  #   cap_add: 
  #     - IPC_LOCK
  #   volumes:
  #     - './_vault/logs:/vault/logs'
  #   environment:
  #     VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8500
  #   ports:
  #     - 8500:8500
  #   labels:
  #     traefik.enable: True
  #     traefik.http.services.khazad-dum.loadbalancer.server.port: 8500
  # tyche:
  #   image: postgres:14.3
  #   ports:
  #     - 5432:5432
  #   environment:
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=randompassword
  #     - POSTGRES_DB=PASS
  #   volumes:
  #     - ./pgdata:/var/lib/postgresql/data
  #   labels: # TODO: figure out what we are doing here since this is not serving to 80
  #     traefik.enable: True
  #     # traefik.http.services.khazad-dum.loadbalancer.server.port: 8500
  # enki:
    # image: 'gitlab/gitlab-ce:${GITLAB_VERSION:-latest}'
    # restart: unless-stopped
    # hostname: 'enki.${HOSTNAME_TLD:?err}'
    # environment:
    #   HOSTNAME_TLD: ${HOSTNAME_TLD:?err}
    #   GITLAB_OMNIBUS_CONFIG: | # TODO: Configure Gitlab https://docs.gitlab.com/ee/install/docker.html#pre-configure-docker-container
    #     external_url 'http://enki.$HOSTNAME_TLD'
    #     # Add any other gitlab.rb configuration here, each on its own line
    # volumes:
    #   - ${GITLAB_HOME:?err}/config:/etc/gitlab
    #   - ${GITLAB_HOME:?err}/logs:/var/log/gitlab
    #   - ${GITLAB_HOME:?err}/data:/var/opt/gitlab
    # shm_size: '256m'
    # labels:
    #   traefik.enable: True
    #   traefik.http.services.enki.loadbalancer.server.port: 80
  # astarte:  JS website
  #   image
  # tangaroa:
  #   image